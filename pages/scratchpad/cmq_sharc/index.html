<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/highlight/github.min.css"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/basic.css"> <link rel=icon  href="/assets/favicon.png"> <title>Using ClusterMQ on Sharcnet via SSH</title> <header> <div class=blog-name ><a href="/">Jason Pekos</a></div> <nav> <ul> <li><a href="/">Home</a> <li><a href="/menu1/">Misc stuff</a> <li><a href="/menu2/">Contact</a> <li><a href="/menu3/">Teaching</a> </ul> <img src="/assets/hamburger.svg" id=menu-icon > </nav> </header> <div class=franklin-content > <h1 id=whats_this_about ><a href="#whats_this_about" class=header-anchor >What&#39;s this about?</a></h1> <p>This is a guide to using ClusterMQ on Sharcnet via SSH. It&#39;s a work in progress — let me know if something is unclear&#33; The goal of this is to get you to the point where you can submit jobs using the <code>Q&#40;&#41;</code> function from a local machine. </p> <h2 id=installing_clustermq_and_zeromq_locally ><a href="#installing_clustermq_and_zeromq_locally" class=header-anchor >Installing ClusterMQ and ZeroMQ locally </a></h2> <p>What you do here depends on your local machine. A complete guide can be found <a href="https://mschubert.github.io/clustermq/articles/userguide.html#installation">here</a>.</p> <h2 id=installing_clustermq_and_zeromq_on_the_cluster ><a href="#installing_clustermq_and_zeromq_on_the_cluster" class=header-anchor >Installing ClusterMQ and ZeroMQ on the cluster </a></h2> <p>The ComputeCanada clusters should already have ZeroMQ installed. You should install ClusterMQ in the R module you plan on using by starting a session and running:</p> <pre><code class="R hljs">install.packages<span class=hljs-punctuation >(</span><span class=hljs-string >&quot;clustermq&quot;</span><span class=hljs-punctuation >)</span></code></pre>
<h1 id=setting_up_your_r_profiles_and_slurm_template ><a href="#setting_up_your_r_profiles_and_slurm_template" class=header-anchor >Setting up your R profiles and Slurm template</a></h1>
<h2 id=on_your_local_machine ><a href="#on_your_local_machine" class=header-anchor >On your local machine</a></h2>
<p>You need to add the following to your local <code>.Rprofile</code> file. You can find this file by running <code>file.edit&#40;&quot;~/.Rprofile&quot;&#41;</code> in R. If the file doesn&#39;t exist, create it in your home directory.</p>
<pre><code class="R hljs">options<span class=hljs-punctuation >(</span>
    clustermq.scheduler <span class=hljs-operator >=</span> <span class=hljs-string >&quot;ssh&quot;</span><span class=hljs-punctuation >,</span>
    clustermq.ssh.host <span class=hljs-operator >=</span> <span class=hljs-string >&quot;user@host&quot;</span><span class=hljs-punctuation >,</span> <span class=hljs-comment ># e.g. bob@graham.computecanada.ca</span>
    clustermq.ssh.log <span class=hljs-operator >=</span> <span class=hljs-string >&quot;~/cmq_ssh.log&quot;</span> <span class=hljs-comment ># ssh log location</span>
<span class=hljs-punctuation >)</span></code></pre>
<h2 id=on_the_cluster ><a href="#on_the_cluster" class=header-anchor >On the cluster</a></h2>
<p>You need to add the following to your cluster <code>.Rprofile</code> file. You can find this file in your home directory:</p>
<pre><code class="R hljs">options<span class=hljs-punctuation >(</span>
    clustermq.template <span class=hljs-operator >=</span> <span class=hljs-string >&quot;/path_to_file/slurm.tmpl&quot;</span>
<span class=hljs-punctuation >)</span></code></pre>
<p>You also need to create a <code>.tmpl</code> file &#40;in the example above, this is <code>slurm.tmpl</code>&#41; in the same directory. Here&#39;s an example, taken from of I use &#40;via mschubert&#41;:</p>
<pre><code class="bash hljs"><span class=hljs-meta >#!/bin/sh</span>

<span class=hljs-comment ># Modified from https://github.com/mschubert/clustermq/blob/master/inst/SLURM.tmpl</span>
<span class=hljs-comment ># under the Apache 2.0 license.</span>

<span class=hljs-comment >#SBATCH --job-name=superconservative_halcyon_{{ job_name }}</span>
<span class=hljs-comment >#SBATCH --output={{ log_file | /dev/null }}</span>
<span class=hljs-comment >#SBATCH --error={{ log_file | /dev/null }}</span>
<span class=hljs-comment >#SBATCH --mem-per-cpu={{ memory | 3G }}</span>
<span class=hljs-comment >#SBATCH --array=1-{{ n_jobs }}</span>
<span class=hljs-comment >#SBATCH --cpus-per-task={{ cores | 4 }}</span>
<span class=hljs-comment >#SBATCH --account=ACCOUNT NAME YOU WANT GOES HERE e.g. def-abc &lt;--- change this</span>
<span class=hljs-comment >#SBATCH --time=0-00:10  &lt;--- change this</span>

module load R <span class=hljs-comment ># Comment out if R is not an environment module.</span>
<span class=hljs-comment ># ulimit -v $(( 1024 * {{ memory | 3G }} ))</span>
CMQ_AUTH={{ auth }} R --no-save --no-restore -e <span class=hljs-string >&#x27;clustermq:::worker(&quot;{{ master }}&quot;)&#x27;</span></code></pre>
<h2 id=also_on_the_cluster_-_adding_the_r_module_you_want_to_your_bashrc ><a href="#also_on_the_cluster_-_adding_the_r_module_you_want_to_your_bashrc" class=header-anchor >Also on the cluster –- Adding the R module you want to your bashrc.</a></h2>
<p>You need to add the R module you want to use to the end of your bashrc. If you don&#39;t, you&#39;ll fail with</p>
<pre><code class="bash hljs">Error <span class=hljs-keyword >in</span> initialize(...) : 
  Remote R process did not respond after 5000 seconds. Check your SSH server <span class=hljs-built_in >log</span>.</code></pre>
<p>For example, I use the following:</p>
<pre><code class="bash hljs"><span class=hljs-comment ># .bashrc</span>

<span class=hljs-comment ># Source global definitions</span>
<span class=hljs-keyword >if</span> [ -f /etc/bashrc ]; <span class=hljs-keyword >then</span>
	. /etc/bashrc
<span class=hljs-keyword >fi</span>

<span class=hljs-comment ># Uncomment the following line if you don&#x27;t like systemctl&#x27;s auto-paging feature:</span>
<span class=hljs-comment ># export SYSTEMD_PAGER=</span>

<span class=hljs-comment ># User specific aliases and functions</span>
module load r/4.2.2 <span class=hljs-comment ># &lt;--- this is the line you need to add</span></code></pre>
<h1 id=testing_if_this_works ><a href="#testing_if_this_works" class=header-anchor >Testing if this works:</a></h1>
<p>The following should work &#40;you&#39;ll be prompted for your password or ssh key&#41;:</p>
<pre><code class="R hljs">library<span class=hljs-punctuation >(</span>clustermq<span class=hljs-punctuation >)</span>

fx <span class=hljs-operator >=</span> <span class=hljs-keyword >function</span><span class=hljs-punctuation >(</span>x<span class=hljs-punctuation >)</span> x <span class=hljs-operator >*</span> <span class=hljs-number >2</span>

Q<span class=hljs-punctuation >(</span>fx<span class=hljs-punctuation >,</span> x<span class=hljs-operator >=</span><span class=hljs-number >1</span><span class=hljs-operator >:</span><span class=hljs-number >3</span><span class=hljs-punctuation >,</span> n_jobs<span class=hljs-operator >=</span><span class=hljs-number >1</span><span class=hljs-punctuation >)</span></code></pre>
<div class=page-foot >
    JasonPekos. Last modified: May 22, 2023.
    Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a>.
</div>


<script>
    var coll = document.getElementsByClassName("collapsible");
    var i;
    
    for (i = 0; i < coll.length; i++) {
      coll[i].addEventListener("click", function() {
        this.classList.toggle("active");
        var content = this.nextElementSibling;
        if (content.style.display === "block") {
          content.style.display = "none";
        } else {
          content.style.display = "block";
        }
      });
    }
  </script>
  
</div>